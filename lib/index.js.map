{"version":3,"file":"index.js","sources":["../src/vue/dep.js","../src/vue/watcher.js","../src/vue/compiler.js","../src/vue/observer.js","../src/vue/vue.js"],"sourcesContent":["export default class Dep{\r\n    static target\r\n\r\n    constructor(){\r\n        this.subs=[];\r\n    }\r\n\r\n    //搜集观察者\r\n    addSub(watcher){\r\n        this.subs.push(watcher);\r\n    }\r\n\r\n    notify(){\r\n        this.subs.forEach(watcher=>{\r\n            watcher.update();\r\n        })\r\n    }\r\n    \r\n}\r\n\r\nDep.target = null;\r\nconst targetStack = []\r\n\r\nexport function pushTarget(watcher){\r\n    targetStack.push(Dep.target);\r\n    Dep.target = watcher;\r\n}\r\n\r\nexport function popTarget(){\r\n    targetStack.pop();\r\n    Dep.target = targetStack[targetStack.length-1]\r\n}\r\n\r\n","import {compileUtil} from './compiler'\r\nimport {pushTarget,popTarget} from './dep'\r\n\r\nexport default class Watcher{\r\n    constructor(vm,expr,callback){\r\n        this.vm= vm;\r\n        this.expr = expr;\r\n        this.cb = callback;\r\n        this.oldVal = this.getOldValue();\r\n    }\r\n\r\n    getOldValue(){\r\n        pushTarget(this) //添加依赖搜集\r\n        const oldVal=compileUtil.filterExpr(this.expr,this.vm);\r\n        popTarget();\r\n        return oldVal;\r\n    }\r\n\r\n    update(){\r\n        const newVal = compileUtil.filterExpr(this.expr,this.vm);\r\n        if(newVal!==this.oldVal){\r\n            this.cb(newVal);\r\n        }\r\n    }\r\n}","import Watcher from './watcher'\r\n\r\nexport class compileUtil {\r\n    static getValue(expr, vm) {\r\n        const value= expr.split('.').reduce((current, prop) => {\r\n            return current[prop]\r\n        }, vm.$data)\r\n        return value;\r\n    }\r\n\r\n\r\n    static setValue(expr,vm,newVal){\r\n        expr.split(',').reduce((current,prop)=>{\r\n            current[prop] = newVal;\r\n        },vm.$data)\r\n    }\r\n\r\n    static filterExpr(expr,vm){\r\n        let value;\r\n        if(/\\{\\{(.+?)\\}\\}/g.test(expr)){\r\n            value= expr.replace(/\\{\\{(.+?)\\}\\}/g,(...args)=>{\r\n                const res= this.getValue(args[1],vm);\r\n                return res;\r\n            })\r\n        }else{\r\n            value = this.getValue(expr,vm);\r\n        }\r\n        return value;\r\n    }\r\n\r\n    static text(node, expr, vm) {\r\n        const value = this.filterExpr(expr, vm);\r\n        new Watcher(vm,expr,newVal=>{\r\n            console.log(newVal);\r\n            this.textUpdater(node,newVal);\r\n        })\r\n        this.textUpdater(node, value);\r\n    }\r\n    static html(node, expr, vm) {\r\n        const value = this.getValue(expr, vm);\r\n        new Watcher(vm,expr,newVal=>{\r\n            this.htmlUpdater(node,newVal);\r\n        })\r\n        this.htmlUpdater(node,value);\r\n    }\r\n    static model(node, expr, vm) { \r\n        const value = this.getValue(expr,vm);\r\n        new Watcher(vm,expr,newVal=>{\r\n            this.modelUpdater(node,newVal);\r\n        })\r\n\r\n        node.addEventListener(\"input\",({target:{value}})=>{\r\n            console.log(value);\r\n            this.setValue(expr,vm,value);\r\n        })\r\n\r\n        this.modelUpdater(node,value);\r\n    }\r\n    static on(node, expr, vm, event) { \r\n        const {methods} = vm.$options;\r\n        let fn;\r\n        if(/\\((.+?)\\)/g.test(expr)){\r\n            const [,func,paramsExpr]=expr.match(/(\\w+)\\((.+?)\\)/),\r\n            params = paramsExpr.split(\",\").map(item=>{\r\n                return this.getValue(item,vm);\r\n            })\r\n            fn = methods[func].bind(vm,...params);\r\n        }else{\r\n            fn =  methods[expr].bind(vm)\r\n        }\r\n        node.addEventListener(event,fn,false);\r\n    }\r\n\r\n    static modelUpdater(node,value){\r\n        node.value = value;\r\n    }\r\n\r\n    static textUpdater(node, value) {\r\n        node.textContent = value;\r\n    }\r\n    static htmlUpdater(node,value) {\r\n        node.innerHTML = value;\r\n    }\r\n\r\n}\r\n\r\nexport default class Compiler {\r\n    constructor(el, vm) {\r\n        this.el = this.isNode(el) ? el : document.querySelector(`${el}`);\r\n        this.vm = vm;\r\n        //获取文档碎片\r\n        const fragment = this.nodeToFragment(this.el);\r\n\r\n        //编译文档碎片\r\n        this.compile(fragment);\r\n\r\n        this.el.appendChild(fragment);\r\n    }\r\n\r\n\r\n    compile(fragment) {\r\n        // 1.获取子节点\r\n        const childNodes = fragment.childNodes;\r\n        [...childNodes].forEach(node => {\r\n            if (this.isNode(node)) {\r\n                //编译元素节点\r\n                this.compileElement(node);\r\n            } else {\r\n                //文本节点\r\n                this.compileText(node);\r\n            }\r\n            if (node.childNodes && node.childNodes.length) this.compile(node);\r\n        })\r\n    }\r\n\r\n\r\n    compileElement(node) {\r\n        const { attributes } = node;\r\n        [...attributes].forEach(attr => {\r\n            const { name, value } = attr;\r\n            if (this.isDirective(name)) {\r\n                const [, directive] = name.split(\"-\");\r\n                const [atName, eventName] = directive.split(\":\");\r\n                compileUtil[atName](node, value, this.vm, eventName);\r\n                node.removeAttribute(`v-${directive}`);\r\n            }else if(this.isAtEventName(name)){\r\n                const [,event] = name.split(\"@\");\r\n                compileUtil[\"on\"](node,value,this.vm,event);\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n    isAtEventName(attrName){\r\n        return attrName.startsWith(\"@\");\r\n    }\r\n\r\n\r\n    isDirective(attrName) {\r\n        return attrName.startsWith(\"v-\");\r\n    }\r\n\r\n    compileText(node) {\r\n        const {textContent} = node;\r\n        if(/\\{\\{(.+?)\\}\\}/g.test(textContent)){\r\n            compileUtil['text'](node,textContent,this.vm)\r\n        }\r\n    }\r\n\r\n    nodeToFragment(el) {\r\n        const f = document.createDocumentFragment();\r\n        let fragment\r\n        while (fragment = el.firstChild) {\r\n            f.appendChild(fragment);\r\n        }\r\n        return f;\r\n    }\r\n\r\n    isNode(node) {\r\n        return node.nodeType === 1;\r\n    }\r\n}\r\n\r\n","import Dep from './dep'\r\n\r\nexport default class Observer{\r\n    constructor(data){\r\n        this.observe(data);\r\n    }\r\n\r\n    observe(data){\r\n        if(data&& typeof data==='object'){\r\n            Object.keys(data).forEach(key=>{\r\n                this.defineReactive(data,key,data[key]);\r\n            })\r\n        }\r\n    }\r\n\r\n    defineReactive(data,key,value){\r\n        const _this = this;\r\n        const dep  = new Dep();\r\n        _this.observe(value);\r\n        \r\n        Object.defineProperty(data,key,{\r\n            enumerable:true,\r\n            configurable:true,\r\n            get:function reactiveGetter(){\r\n                //订阅数据变化，添加观察者\r\n                Dep.target && dep.addSub(Dep.target);\r\n                return value\r\n            },\r\n            set:function (newVal){\r\n                _this.observe(newVal);\r\n                if(newVal!==value){\r\n                    value=newVal\r\n                }\r\n                dep.notify();\r\n            }\r\n        })\r\n    }\r\n\r\n\r\n}","import Compiler from './compiler'\r\nimport Observer from './observer'\r\n\r\nexport default class Vue {\r\n    constructor($options) {\r\n        this.$el = $options.el;\r\n        this.$data = $options.data;\r\n        this.$options = $options;\r\n        if (this.$el) {\r\n            // 初始化\r\n            // 1. 实现监听器\r\n            new Observer(this.$data);\r\n            // 2. 实现解析器\r\n            new Compiler(this.$el, this)\r\n\r\n            // 3.设置代理\r\n            this.proxyData();\r\n\r\n        }\r\n    }\r\n\r\n    proxyData(){\r\n        const {$data} = this;\r\n        for(let key in $data){\r\n            Object.defineProperty(this,key,{\r\n                get(){\r\n                    return $data[key]\r\n                },\r\n                set(newVal){\r\n                    $data[key]=newVal;\r\n                }\r\n            })\r\n        }\r\n    }\r\n}\r\n\r\n"],"names":["Dep","subs","watcher","push","forEach","update","target","targetStack","pushTarget","popTarget","pop","length","Watcher","vm","expr","callback","cb","oldVal","this","getOldValue","compileUtil","filterExpr","newVal","split","reduce","current","prop","$data","test","replace","_this","getValue","node","value","console","log","_this2","textUpdater","_this3","htmlUpdater","_this4","modelUpdater","addEventListener","setValue","event","fn","methods","$options","match","func","params","map","item","_this5","bind","textContent","innerHTML","Compiler","el","isNode","document","querySelector","fragment","nodeToFragment","compile","appendChild","childNodes","_this6","compileElement","compileText","attributes","attr","name","_this7","isDirective","directive","atName","eventName","removeAttribute","isAtEventName","attrName","startsWith","f","createDocumentFragment","firstChild","nodeType","Observer","data","observe","_typeof","Object","keys","key","defineReactive","dep","defineProperty","enumerable","configurable","get","addSub","set","notify","Vue","$el","proxyData"],"mappings":"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"}